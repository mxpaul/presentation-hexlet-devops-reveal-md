---
title: DNS
theme: night
revealOptions:
  #transition: 'slide'
  controls: true
  mouseWheel: false
  progress: true
---

# DNS как часть инфраструктуры

## Практическое занятие

---

# План занятия

- Что будем строить сегодня
- Что вынесем с занятия
- Начальные сведения о DNS: зачем нужен, как устроен
- Конфигурация named при помощи ansible
- Работа с внешними ролями и коллекциями на примере nginx

---

# Что будем строить сегодня

https://github.com/mxpaul/infragrant

- Vagrant multimachine infra
- Два DNS сервера для зоны devops.club
- Front: Статический html на nginx 
- Всё на ansible

---

# Что вынесем с занятия

- Что происходит под капотом в Digital Ocean при привязке домена
- Разработка собственных ролей ansible: best practices
- Использование внешних ролей и IaC
- Работа с множеством серверов из ansible

---

# Что значит DNS и зачем он нужен

- Domain Name System (доменная система имен)
- TCP/IP сети оперируют IP адресами
- DNS позволяет узнать на какой IP отправить запрос для указанного домена

---

# Основные понятия доменной системы

- Домен (область внутри чего-то целого)
- Вложенность и уровни (корневой домен, поддомены 1, 2 и 3 уровней)
- Основные типы записей
  - A и AAAA (Address)
  - PTR (Pointer)

---

# Основные понятия доменной системы

- Типы серверов
  - Authoritative vs Non-Authoritative
  - Recursive vs Non-recursive
  - Primary(master) vs Secondary(slave)

---

# Зачем нужен DNS в инфраструктуре

- Что прописать в /etc/resolv.conf на своих серверах
  - 8.8.8.8 может быть недоступен
  - 8.8.8.8 могут взломать или подменить
  - 8.8.8.8 может не знать про наши внутренние домены
- Предоставление внешним клиентам информации о своей системе

---

# Multi-machine Vagrantfile

- Несколько define-ов
- Vagrantfile это программа на ruby, можно делать хеши и циклы
- Генерация ansible inventory из vagrant


---

# Организация файлов ansible-playbook

- ansible/site.yml - входная точка, import всего
- ansible/nameservers.yml - роли для DNS-серверов
  - Можно задавать vars для каждой роли
  - Можно использовать `group_vars` или `host_vars`
- Версии прибиваем гвоздями

---

# Разбиение роли на структуру каталогов и файлов

- defaults/main.yml и vars/main.yml для переменных
- tasks/main.yml для шагов
- handlers/main.yml - рестарт и релоад
- files и tempaltes для файлов и шаблонов

---

# Использование переменных

- Способ раскатить 100 серверов с разными параметрами
- Всегда должны быть переменные для версий софта
- В основном в `group_vars`, исключения в `host_vars`

---

# Работа с ansible-galaxy

- requirments.yml с фиксированными версиями
- ansible.cfg складывает роли и коллекции в git
- make galaxy для осознанного обновления ролей и коллекций

---

# Работа с ansible-vault

- `--vault-id "my_id@~/.my_password_file"` для работы с ansible-vault
- одинаковые параметры для ansible-playbook и ansible-vault
- ctrl+z и осторожность с переводом строки 

---

# Частичная раскладка

- --limit позволяет кикнуть одну тачку или группу
- Проставляем теги к таскам в роли
- Управляем при помощи --tags тем какие таски будут выполняться

---

# Проблемы с DNS

- Много серверов в цепочке между клиентом и сервисом
- Несогласованные ответы
- Тухлые кеши ломают балансировку DNS
- Возможность заблокироваться в приложении
- Можно случайно уложить сервис множеством соединений в один хост

---

# Вопросы

https://github.com/mxpaul/infragrant
